<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Finance Analyzer</title>
    <style>
        /* --- Preloader Styles (Dark Theme) --- */
        #preloader-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.85); /* Slightly darker */
            backdrop-filter: blur(5px);
            display: none; /* Hidden by default */
            justify-content: center;
            align-items: center;
            z-index: 9999;
            flex-direction: column;
        }
        #preloader-img {
             width: 150px; /* Adjusted size for the new GIF */
             height: auto;
             margin-bottom: 20px;
        }

        #preloader-overlay p {
            font-size: 1.2em;
            color: #f0f0f0;
        }

        /* --- Page Fade-In Animation --- */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* --- Button Pulse Animation --- */
        @keyframes pulse {
            0% { box-shadow: 0 0 0 0 rgba(0, 242, 234, 0.7); }
            70% { box-shadow: 0 0 0 10px rgba(0, 242, 234, 0); }
            100% { box-shadow: 0 0 0 0 rgba(0, 242, 234, 0); }
        }

        /* --- General Styles --- */
        :root {
            --accent-color: #00f2ea;
            --glass-bg: rgba(30, 30, 30, 0.6);
            --glass-light-bg: rgba(45, 45, 45, 0.6);
            --glass-border: rgba(255, 255, 255, 0.1);
            --glass-blur: blur(12px);

            --text-color: #f5f5f5;
            --text-secondary: #c0c0c0;
            --text-dark: #121212;
            --smooth-curve: cubic-bezier(0.25, 0.46, 0.45, 0.94);
            --text-shadow: 0 1px 3px rgba(0, 0, 0, 0.5);
        }

        html {
            scroll-behavior: smooth;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Arial, sans-serif;
            margin: 0;
            padding: 0;
            color: var(--text-color);
            background-image: url('https://pirimidtech.com/wp-content/uploads/2021/06/preparing-financial-statements.jpeg');
            background-size: cover;
            background-position: center;
            background-attachment: fixed;
            background-repeat: no-repeat;
        }

        #welcome-screen {
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            height: 100vh;
            padding: 20px;
            text-align: center;
            animation: fadeIn 1s var(--smooth-curve);
        }
        #welcome-screen h1 {
            font-size: 3.5em;
            color: white;
            text-shadow: var(--text-shadow);
            animation: fadeIn 1s var(--smooth-curve) 0.2s backwards;
        }
        #welcome-screen p {
            font-size: 1.3em;
            color: var(--text-secondary);
            text-shadow: var(--text-shadow);
            max-width: 500px;
            animation: fadeIn 1s var(--smooth-curve) 0.4s backwards;
        }
        .cta-button { /* "Get Started" button */
            display: inline-block;
            padding: 15px 35px;
            margin-top: 30px;
            background: var(--accent-color);
            color: var(--text-dark);
            border: none;
            border-radius: 50px;
            cursor: pointer;
            font-size: 1.1em;
            font-weight: bold;
            text-decoration: none;
            transition: all 0.3s var(--smooth-curve);
            animation: fadeIn 1s var(--smooth-curve) 0.6s backwards;
        }
        .cta-button:hover {
            transform: translateY(-5px) scale(1.05);
            box-shadow: 0 10px 20px rgba(0, 242, 234, 0.3);
        }


        .main-content {
            padding: 20px 10px;
        }

        nav, .upload-container {
            max-width: 1000px;
            margin: 10px auto 20px auto;
            padding: 20px;
            background: var(--glass-bg);
            backdrop-filter: var(--glass-blur);
            border-radius: 12px;
            border: 1px solid var(--glass-border);
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
            animation: fadeIn 0.5s ease-out;
        }
        .brand {
            font-size: 1.3em;
            font-weight: bold;
            color: var(--accent-color);
        }

        nav {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .nav-link {
            font-size: 0.9em;
            font-weight: 500;
            color: var(--accent-color);
            text-decoration: none;
            transition: opacity 0.3s var(--smooth-curve);
        }
        .nav-link:hover {
            opacity: 0.8;
        }

        h2 {
            color: var(--text-color);
            padding-bottom: 15px;
            margin-top: 0;
            position: relative;
            text-shadow: var(--text-shadow);
        }

        h2::after {
            content: '';
            display: block;
            width: 80px;
            height: 4px;
            background: var(--accent-color);
            margin-top: 10px;
            border-radius: 2px;
        }

        p {
            color: var(--text-secondary);
            line-height: 1.6;
        }

        .upload-container h2 {
            animation: fadeIn 0.5s ease-out 0.1s backwards;
        }
        .upload-container p {
            animation: fadeIn 0.5s ease-out 0.3s backwards;
        }
        .upload-container .upload-form {
            animation: fadeIn 0.5s ease-out 0.5s backwards;
        }

        .upload-form {
            padding: 20px;
            border-radius: 8px;
            background: var(--glass-light-bg);
            backdrop-filter: var(--glass-blur);
            border: 1px solid var(--glass-border);
            text-align: center;
        }

        input[type="file"] { display: none; }

        .custom-file-upload {
            display: inline-block;
            padding: 12px 25px;
            background-color: var(--accent-color);
            color: var(--text-dark);
            border-radius: 8px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s var(--smooth-curve);
            animation: pulse 2s infinite 1s;
        }
        .custom-file-upload:hover {
            transform: translateY(-3px);
            box-shadow: 0 5px 15px rgba(0, 242, 234, 0.3);
            animation: none;
        }

        #file-name {
            display: block;
            margin-top: 15px;
            font-style: italic;
            color: #aaa;
        }

        button[type="submit"] {
            display: block;
            width: 80%;
            margin: 25px auto 0;
            padding: 12px 18px;
            background: var(--accent-color);
            color: var(--text-dark);
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            font-weight: bold;
            transition: all 0.3s var(--smooth-curve);
        }
        button[type="submit"]:hover {
            transform: translateY(-3px);
            box-shadow: 0 5px 15px rgba(0, 242, 234, 0.3);
        }

        .error {
            color: #ffc4c4;
            background-color: rgba(140, 28, 28, 0.7);
            backdrop-filter: var(--glass-blur);
            border: 1px solid #ff4d4d;
            padding: 15px;
            border-radius: 8px;
            margin-top: 20px;
            font-weight: bold;
            animation: fadeIn 0.5s ease-out;
        }

        .results {
            max-width: 1000px;
            margin: 20px auto;
            text-align: center;
            animation: fadeIn 0.8s ease-out;
        }

        .results-header {
            background: var(--glass-bg);
            backdrop-filter: var(--glass-blur);
            border: 1px solid var(--glass-border);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .download-buttons {
            display: flex;
            justify-content: center;
            gap: 15px;
            flex-wrap: wrap;
        }

        .graph-row {
            display: flex;
            flex-wrap: wrap;
            justify-content: space-around;
            gap: 20px;
            margin-top: 20px;
        }

        .graph-container {
            flex: 1;
            min-width: 300px;
            padding: 15px;
            background: var(--glass-light-bg);
            backdrop-filter: var(--glass-blur);
            border: 1px solid var(--glass-border);
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
            transition: all 0.3s var(--smooth-curve);
        }
        .graph-container:hover {
            transform: translateY(-5px);
        }

        .graph-container.full-width {
            flex-basis: 100%;
            min-width: 90%;
        }

        h3 {
            color: var(--text-color);
            text-shadow: var(--text-shadow);
        }

        .graph-container img {
            max-width: 100%;
            height: auto;
            border-radius: 4px;
            cursor: pointer;
            transition: transform 0.3s var(--smooth-curve);
        }
        .graph-container img:hover {
             transform: scale(1.02);
        }

        a.download-link {
            display: inline-block;
            width: auto;
            margin: 10px 0;
            padding: 12px 25px;
            background: var(--accent-color);
            color: var(--text-dark);
            text-decoration: none;
            border-radius: 8px;
            font-weight: bold;
            font-size: 16px;
            transition: all 0.3s var(--smooth-curve);
        }
        a.download-link:hover {
            transform: translateY(-3px) scale(1.03);
            box-shadow: 0 5px 15px rgba(0, 242, 234, 0.3);
        }

        a.download-link.pdf {
            background: #E74C3C;
            color: white;
        }
        a.download-link.pdf:hover {
            box-shadow: 0 5px 15px rgba(231, 76, 60, 0.3);
        }

        .upload-note {
            font-size: 0.9em;
            color: var(--text-secondary);
            margin: 15px 0 5px 0;
            text-align: left;
            padding: 10px;
            background: rgba(0,0,0,0.1);
            border-radius: 8px;
        }
        .upload-note a {
            color: var(--accent-color);
            font-weight: bold;
            text-decoration: none;
        }
        .upload-note a:hover {
            text-decoration: underline;
        }
        .privacy-note {
            margin-top: 20px;
            font-size: 0.85em;
            color: #aaa;
            line-height: 1.5;
        }
        .icon {
            margin-right: 10px;
            font-size: 1.1em;
            vertical-align: middle;
        }

        .largest-transactions {
            background: var(--glass-bg);
            backdrop-filter: var(--glass-blur);
            border: 1px solid var(--glass-border);
            border-radius: 12px;
            padding: 20px;
            margin-top: 20px;
        }
        .txn-columns {
            display: flex;
            justify-content: space-around;
            flex-wrap: wrap;
            gap: 20px;
        }
        .txn-list {
            flex: 1;
            min-width: 250px;
            text-align: left;
        }
        .txn-list h4 {
            color: var(--text-color);
            margin-bottom: 10px;
            border-bottom: 1px solid var(--glass-border);
            padding-bottom: 5px;
            text-shadow: var(--text-shadow);
        }
        .txn-list ul {
            list-style: none;
            padding: 0;
            margin: 0;
        }
        .txn-list li {
            background: var(--glass-light-bg);
            padding: 10px;
            border-radius: 5px;
            margin-bottom: 10px;
            font-size: 0.9em;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border: 1px solid var(--glass-border);
        }
        .txn-details {
            flex-grow: 1;
            margin-right: 10px;
            overflow: hidden;
            white-space: nowrap;
            text-overflow: ellipsis;
        }
        .txn-details strong {
            display: block;
            color: var(--text-color);
             overflow: hidden;
            white-space: nowrap;
            text-overflow: ellipsis;
        }
        .txn-details span {
            font-size: 0.85em;
            color: var(--text-secondary);
        }
        .txn-amount {
            font-weight: bold;
            white-space: nowrap;
        }
        .txn-amount.debit { color: #ff8a80; }
        .txn-amount.credit { color: #b9f6ca; }


        footer {
            max-width: 1000px;
            margin: 40px auto 20px auto;
            padding: 25px;
            background: var(--glass-bg);
            backdrop-filter: var(--glass-blur);
            border: 1px solid var(--glass-border);
            border-radius: 12px;
            text-align: center;
            font-size: 0.9em;
            color: var(--text-secondary);
            animation: fadeIn 1s ease-out;
        }
        footer h4 {
            color: var(--text-color);
            margin-top: 0;
        }
        footer p {
            font-size: 0.9em;
            margin: 10px 0;
        }

        #lightbox {
            display: none;
            position: fixed;
            z-index: 10000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0, 0, 0, 0.9);
            backdrop-filter: blur(5px);
            justify-content: center;
            align-items: center;
            cursor: pointer;
        }
        #lightbox img {
            margin: auto;
            display: block;
            max-width: 90%;
            max-height: 85vh;
            border-radius: 5px;
            animation: zoomIn 0.4s var(--smooth-curve);
            cursor: default;
        }
        @keyframes zoomIn {
            from {transform: scale(0.8); opacity: 0;}
            to {transform: scale(1); opacity: 1;}
        }
        .close-lightbox {
            position: absolute;
            top: 20px;
            right: 35px;
            color: #f1f1f1;
            font-size: 40px;
            font-weight: bold;
            transition: 0.3s;
            cursor: pointer;
            z-index: 10001;
            text-shadow: 0 2px 5px rgba(0,0,0,0.7);
        }
        .close-lightbox:hover,
        .close-lightbox:focus {
            color: #bbb;
            text-decoration: none;
        }

        @media (max-width: 768px) {
            body {
                padding: 0;
            }
            .main-content {
                padding: 10px;
            }

            #welcome-screen h1 {
                font-size: 2.5em;
            }
            #welcome-screen p {
                font-size: 1.1em;
            }

            nav, .upload-container, .results-header, footer, .largest-transactions {
                padding: 15px;
                margin: 10px;
                border-radius: 10px;
            }

            .brand {
                font-size: 1.1em;
            }
            .nav-link {
                font-size: 0.8em;
            }

            h2 {
                font-size: 1.4em;
            }

            .graph-row {
                flex-direction: column;
                gap: 15px;
                margin-top: 15px;
            }
            .graph-container {
                min-width: 95%;
            }

            button[type="submit"], a.download-link {
                width: 90%;
                padding: 14px 20px;
            }
            .download-buttons {
                flex-direction: column;
                align-items: center;
                gap: 10px;
            }
             #lightbox img {
                max-width: 95%;
            }
            .close-lightbox {
                 top: 15px;
                 right: 25px;
                 font-size: 30px;
            }
             .txn-columns {
                flex-direction: column;
            }
            .txn-list {
                min-width: 90%;
            }
        }

    </style>
</head>
<body>

    <div id="preloader-overlay">
        <img id="preloader-img" src="https://media.giphy.com/media/v1.Y2lkPTc5MGI3NjExbnJ1bnU1YzRucDZta2tyMjBsOXBpbzIzZDhyZzl1Nnl0ZjN0ejU1YSZlcD12MV9naWZzX3NlYXJjaCZjdD1n/JrXas5ecb4FkwbFpIE/giphy.gif" alt="Analyzing...">
        <p>Analyzing your statement...</p>
    </div>

    <div id="lightbox" onclick="closeLightbox()">
        <span class="close-lightbox" onclick="closeLightbox()">&times;</span>
        <img id="lightbox-img" src="" alt="Expanded Graph" onclick="event.stopPropagation()">
    </div>


    {% if not graph_url %}

        <div id="welcome-screen">
            <h1>Welcome to the Finance Analyzer</h1>
            <p>Get a complete, visual analysis of your financial statements in seconds.
               Your data is secure and never saved.</p>
            <a href="#upload-section" class="cta-button">Get Started</a>
        </div>

        <div class="main-content" id="upload-section">
            <nav>
                <div class="brand">Finance Analyzer</div>
            </nav>

            {% if error %}
                <div class="upload-container">
                    <p class="error">{{ error }}</p>
                    <a href="/" class="nav-link" style="text-align: center; display: block; margin-top: 20px;">Try Again</a>
                </div>
            {% endif %}

            {% if not error %}
            <div class="upload-container">
                <h2>Upload Your Statement</h2>
                <p>Upload your Excel file to generate your personal dashboard.</p>

                <form class="upload-form" action="/upload" method="POST" enctype="multipart/form-data" onsubmit="showPreloader()">

                    <p class="upload-note">
                        <span class="icon">&#128193;</span>
                        We only accept <strong>Excel files (.xlsx, .xls)</strong>.
                    </p>
                    <p class="upload-note">
                        <span class="icon">&#128190;</span>
                        Need to convert a PDF? Try a free tool like
                        <a href="https://www.ilovepdf.com/pdf_to_excel" target="_blank" rel="noopener noreferrer">iLovePDF</a>.
                    </p>

                    <label for="file-upload" class="custom-file-upload" style="margin-top: 20px;">
                        Click to Choose File
                    </label>
                    <input id="file-upload" type="file" name="file" accept=".xlsx, .xls" required onchange="updateFileName(this)">
                    <span id="file-name">No file selected.</span>

                    <button type="submit">Upload and Analyze</button>

                </form>
            </div>
            {% endif %}

        </div>

    {% else %}

        <nav>
            <div class="brand">Finance Analyzer</div>
            <a href="/" class="nav-link">Analyze Another File</a>
        </nav>

        <div class="results">

            <div class="results-header">
                <h2>Your Financial Analysis</h2>

                <p style="font-size: 1.1em; color: var(--text-secondary); margin-top: -15px;">
                    Displaying analysis from <strong>{{ start_date }}</strong> to <strong>{{ end_date }}</strong>
                </p>

                <div class="download-buttons">
                    <a class="download-link" href="{{ url_for('download_file', filename=download_filename) }}">
                        Download Report (.xlsx) </a>
                </div>
            </div>

            <div class="largest-transactions">
                <div class="txn-columns">
                    <div class="txn-list">
                        <h4>Largest Expenses (Debits)</h4>
                        {% if largest_debits %}
                            <ul>
                                {% for txn in largest_debits %}
                                <li>
                                    <div class="txn-details">
                                        <strong>{{ txn.PayeeOrDetails }}</strong>
                                        <span>{{ txn.Date }}</span>
                                    </div>
                                    <span class="txn-amount debit">{{ txn.Debit }}</span>
                                </li>
                                {% endfor %}
                            </ul>
                        {% else %}
                            <p>No debit transactions found.</p>
                        {% endif %}
                    </div>
                    <div class="txn-list">
                        <h4>Largest Income (Credits)</h4>
                         {% if largest_credits %}
                            <ul>
                                {% for txn in largest_credits %}
                                <li>
                                    <div class="txn-details">
                                        <strong>{{ txn.PayeeOrDetails }}</strong>
                                        <span>{{ txn.Date }}</span>
                                    </div>
                                    <span class="txn-amount credit">{{ txn.Credit }}</span>
                                </li>
                                {% endfor %}
                            </ul>
                        {% else %}
                            <p>No credit transactions found.</p>
                        {% endif %}
                    </div>
                </div>
            </div>


            <div class="graph-row">
                {% if category_pie_url %}
                 <div class="graph-container">
                    <h3>Spending Distribution by Category</h3>
                    <img src="{{ url_for('static', filename=category_pie_url) }}?v={{ range(1, 100000) | random }}"
                         alt="Spending by Category Pie Chart" onclick="openLightbox(this)">
                </div>
                {% endif %}

                {% if pie_chart_url %}
                <div class="graph-container">
                    <h3>Total Debit vs. Credit</h3>
                    <img src="{{ url_for('static', filename=pie_chart_url) }}?v={{ range(1, 100000) | random }}"
                         alt="Debit vs Credit Pie Chart" onclick="openLightbox(this)">
                </div>
                {% endif %}
            </div>

            <div class="graph-row">
                 {% if trend_url %}
                <div class="graph-container">
                    <h3>Monthly Income vs. Expense</h3>
                    <img src="{{ url_for('static', filename=trend_url) }}?v={{ range(1, 100000) | random }}"
                         alt="Income vs Expense Trend Graph" onclick="openLightbox(this)">
                </div>
                {% endif %}

                {% if day_of_week_url %}
                <div class="graph-container">
                    <h3>Spending by Day of Week</h3>
                    <img src="{{ url_for('static', filename=day_of_week_url) }}?v={{ range(1, 100000) | random }}"
                         alt="Spending by Day of Week Graph" onclick="openLightbox(this)">
                </div>
                {% endif %}
            </div>

            <div class="graph-row">
                <div class="graph-container">
                    <h3>Monthly Debit vs. Credit</h3>
                    <img src="{{ url_for('static', filename=graph_url) }}?v={{ range(1, 100000) | random }}"
                         alt="Monthly Summary Graph" onclick="openLightbox(this)">
                </div>

                <div class="graph-container">
                    <h3>Cumulative Balance Over Time</h3>
                    <img src="{{ url_for('static', filename=cum_graph_url) }}?v={{ range(1, 100000) | random }}"
                         alt="Cumulative Balance Graph" onclick="openLightbox(this)">
                </div>
            </div>

            <div class="graph-row">
                {% if top_10_graph_url %}
                <div class="graph-container full-width">
                    <h3>Top 10 Spending (by Payee/Details)</h3>
                    <img src="{{ url_for('static', filename=top_10_graph_url) }}?v={{ range(1, 100000) | random }}"
                         alt="Top 10 Spending Graph" onclick="openLightbox(this)">
                </div>
                {% endif %}
            </div>

        </div>

    {% endif %}
    <footer>
        <h4>Disclaimer</h4>
        <p>This is a data visualization tool. All analysis is generated automatically. The creators of this tool are not responsible for any financial decisions made based on this analysis. Please verify all information with your official bank statements.</p>
        <p style="margin-top: 20px; font-size: 0.8em; color: #aaa;">
            <span class="icon">&#128274;</span>
            **Privacy Note:** We do not save or store any of your personal file data.
            All processing is done in memory and deleted immediately after your session ends.
        </p>
    </footer>


    <script>
        function showPreloader() {
            // Only show preloader if a file is selected
            const fileInput = document.getElementById('file-upload');
            if (fileInput && fileInput.files.length > 0) {
                document.getElementById('preloader-overlay').style.display = 'flex';
            }
        }
        function updateFileName(input) {
            const fileName = input.files[0] ? input.files[0].name : 'No file selected.';
            document.getElementById('file-name').textContent = fileName;
        }

        // --- Lightbox Functions ---
        const lightbox = document.getElementById('lightbox');
        const lightboxImg = document.getElementById('lightbox-img');

        function openLightbox(imgElement) {
            if (lightbox && lightboxImg) {
                lightboxImg.src = imgElement.src; // Set the source of the modal image
                lightbox.style.display = 'flex'; // Show the modal
            }
        }

        function closeLightbox() {
            if (lightbox) {
                lightbox.style.display = 'none'; // Hide the modal
            }
        }
        // --- END Lightbox Functions ---
    </script>

</body>
</html>